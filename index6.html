<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI è‚Œè†šæª¢æ¸¬ç³»çµ± - æ°£è‰² Ã— è†šæ³é¡§å•</title>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils"></script>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        body { 
            margin: 0; padding: 0;
            display: flex; justify-content: center; align-items: center; 
            min-height: 100vh;
            font-family: "PingFang TC", "Microsoft JhengHei", sans-serif;
            background-image: url('background.jpg'); 
            background-size: cover; background-position: center; background-attachment: fixed;
            background-color: #fdfaf5;
            overflow: hidden; /* é˜²æ­¢æ‰‹æ©Ÿæ»‘å‹•è·³å‹• */
        }

        :root { --gold: #d4af37; --white-glass: rgba(255, 255, 255, 0.92); }

        .card { 
            background: var(--white-glass); 
            padding: 2.5rem; border-radius: 30px; 
            box-shadow: 0 15px 35px rgba(0,0,0,0.2); 
            width: 85%; max-width: 400px; 
            text-align: center; backdrop-filter: blur(8px);
            z-index: 10;
        }

        .hidden { display: none; }
        .question { margin-bottom: 20px; text-align: left; }
        label { font-weight: bold; color: #555; display: block; margin-bottom: 5px; }
        
        .btn-gold { 
            background: var(--gold); color: white; border: none; 
            padding: 14px 40px; border-radius: 30px; cursor: pointer; 
            width: 100%; font-size: 16px; font-weight: bold; 
            transition: 0.3s; margin-top: 10px; 
        }
        .btn-gold:active { transform: scale(0.98); background: #b8962d; }

        .video-container { 
            position: relative; width: 100%; border-radius: 20px; 
            overflow: hidden; background: #000; margin-bottom: 20px; 
            border: 2px solid var(--gold); 
        }
        video, canvas { width: 100%; display: block; }
        canvas { position: absolute; top: 0; left: 0; }

        .loading-bar { height: 6px; background: #eee; border-radius: 3px; margin: 15px 0; overflow: hidden; }
        .progress { height: 100%; background: var(--gold); width: 0%; transition: width 0.1s; }

        /* é‡‘ç²‰ç‰¹æ•ˆ */
        .sparkle {
            position: fixed; width: 6px; height: 6px;
            background: var(--gold); border-radius: 50%;
            pointer-events: none; z-index: 99999;
            box-shadow: 0 0 10px #fff7d7, 0 0 20px var(--gold);
            animation: fly 1s forwards;
        }
        @keyframes fly {
            0% { transform: translate(0, 0) scale(1); opacity: 1; }
            100% { transform: translate(var(--mx), var(--my)) scale(0); opacity: 0; }
        }
    </style>
</head>
<body>

<div class="card">
    <div id="step-survey">
        <h2 style="color: var(--gold);">è‚Œè†šè«®è©¢</h2>
        <p>æ‚¨å¥½ï¼Œ<span id="user-name">è¨ªå®¢</span><br>è«‹å…ˆå¡«å¯«æ‚¨çš„åŸºç¤è³‡æ–™</p>
        
        <div class="question">
            <label>è†šè³ªé¡å‹</label>
            <select id="user-skin" style="width:100%; padding:12px; border-radius:10px; border:1px solid #ccc;">
                <option value="ä¹¾æ€§">ä¹¾æ€§</option>
                <option value="æ²¹æ€§">æ²¹æ€§</option>
                <option value="æ··åˆ">æ··åˆ</option>
            </select>
        </div>

        <div class="question">
            <label>å¹´é½¡å€é–“</label>
            <select id="user-age" style="width:100%; padding:12px; border-radius:10px; border:1px solid #ccc;">
                <option value="20-30">20-30 æ­²</option>
                <option value="31-40">31-40 æ­²</option>
                <option value="41+">41 æ­²ä»¥ä¸Š</option>
            </select>
        </div>

        <button class="btn-gold" id="start-analysis-btn">é–‹å§‹ AI åˆ†æ</button>
    </div>

    <div id="step-analysis" class="hidden">
        <h3 style="color: var(--gold);">AI æƒæåµæ¸¬ä¸­...</h3>
        <div class="video-container">
            <video id="video" playsinline></video>
            <canvas id="canvas"></canvas>
        </div>
        <div id="status-text">è«‹å°æº–é¡é ­ä¸¦ä¿æŒä¸å‹•</div>
        <div class="loading-bar"><div id="progress" class="progress"></div></div>
        
        <div id="final-result" class="hidden">
            <h2 style="color:var(--gold);">åˆ†æå ±å‘Š</h2>
            <div id="report-content" style="text-align:left; margin-bottom:20px; line-height: 1.6;"></div>
            <button class="btn-gold" onclick="location.reload()">é‡æ–°æª¢æ¸¬</button>
        </div>
    </div>
</div>

<div id="sparkle-container"></div>

<script>
    let isAnalyzing = false;
    let progress = 0;
    let surveyData = {};
    
    const videoElement = document.getElementById('video');
    const canvasElement = document.getElementById('canvas');
    const canvasCtx = canvasElement.getContext('2d');

    // 1. LIFF åˆå§‹åŒ– (ä¿®æ­£æ‰‹æ©Ÿ ID èˆ‡ç’°å¢ƒå•é¡Œ)
    async function initLiff() {
        try {
            await liff.init({ liffId: "2008812290-AidCIwjS" }); 
            if (liff.isLoggedIn()) {
                const profile = await liff.getProfile();
                document.getElementById('user-name').innerText = profile.displayName;
            } else {
                liff.login();
            }
        } catch (e) { console.log("ä¸åœ¨ LINE ç’°å¢ƒä¸­"); }
    }
    initLiff();

    // 2. é‡‘ç²‰ç‰¹æ•ˆ (ç›¸å®¹æ‰‹æ©Ÿè§¸æ§)
    function createSparkle(e) {
        const x = e.clientX || (e.touches && e.touches[0].clientX);
        const y = e.clientY || (e.touches && e.touches[0].clientY);
        if (!x || !y) return;

        const sparkle = document.createElement('div');
        sparkle.className = 'sparkle';
        sparkle.style.left = x + 'px';
        sparkle.style.top = y + 'px';
        const moveX = (Math.random() - 0.5) * 120;
        const moveY = (Math.random() - 0.5) * 120;
        sparkle.style.setProperty('--mx', `${moveX}px`);
        sparkle.style.setProperty('--my', `${moveY}px`);
        document.getElementById('sparkle-container').appendChild(sparkle);
        setTimeout(() => sparkle.remove(), 1000);
    }
    document.addEventListener('mousemove', createSparkle);
    document.addEventListener('touchmove', createSparkle, { passive: true });

    // 3. æŒ‰éˆ•é¡¯å¼ç¶å®š (ä¿®æ­£æ‰‹æ©Ÿé»æ“Šæ²’åæ‡‰)
    document.getElementById('start-analysis-btn').onclick = function() {
        surveyData = {
            skinType: document.getElementById('user-skin').value,
            ageRange: document.getElementById('user-age').value
        };
        document.getElementById('step-survey').classList.add('hidden');
        document.getElementById('step-analysis').classList.remove('hidden');
        
        // å•Ÿå‹•ç›¸æ©Ÿ
        startCamera();
    };

    // 4. FaceMesh é‚è¼¯
    const faceMesh = new FaceMesh({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${file}`});
    faceMesh.setOptions({ maxNumFaces: 1, refineLandmarks: true, minDetectionConfidence: 0.7 });
    faceMesh.onResults((results) => {
        canvasElement.width = videoElement.videoWidth;
        canvasElement.height = videoElement.videoHeight;
        if (results.multiFaceLandmarks && results.multiFaceLandmarks.length > 0 && isAnalyzing) {
            progress += 0.8; 
            document.getElementById('progress').style.width = progress + '%';
            document.getElementById('status-text').innerText = `åˆ†æé€²åº¦: ${Math.floor(progress)}%`;
            if (progress >= 100) {
                isAnalyzing = false;
                completeAnalysis();
            }
        }
    });

    async function startCamera() {
        const camera = new Camera(videoElement, {
            onFrame: async () => { await faceMesh.send({image: videoElement}); },
            width: 640, height: 480
        });
        await camera.start();
        isAnalyzing = true;
    }

    function completeAnalysis() {
        document.getElementById('status-text').classList.add('hidden');
        document.getElementById('final-result').classList.remove('hidden');
        const finalScore = Math.floor(Math.random() * 15 + 85); 
        
        document.getElementById('report-content').innerHTML = `
            <b>ã€AI æª¢æ¸¬æ‘˜è¦ã€‘</b><br>
            âœ¨ æª¢æ¸¬å°è±¡ï¼š${document.getElementById('user-name').innerText}<br>
            âœ¨ è‚Œè†šå¾—åˆ†ï¼š<span style="color:var(--gold); font-size: 20px;">${finalScore} åˆ†</span><br>
            ğŸ§¬ è†šè³ªç‹€æ…‹ï¼š${surveyData.skinType}è‚Œ<br>
            ğŸ’¡ å°ˆæ¥­å»ºè­°ï¼šæ‚¨çš„ç‹€æ³è‰¯å¥½ï¼Œè«‹æŒçºŒç¶­æŒç›®å‰çš„ä¿é¤Šç¿’æ…£ã€‚
        `;
        // æ•¸æ“šå‚³é€ MySQL é‚è¼¯ä¿ç•™åœ¨ console
        console.log("æ•¸æ“šå·²å­˜æª”ï¼š", { ...surveyData, score: finalScore });
    }
</script>
</body>
</html>
